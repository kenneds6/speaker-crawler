import os
import subprocess
import time
##import pandas as pd
from scapy.all import sniff
from scapy.all import wrpcap
from threading import Thread

class Sniffer(Thread):
    def __init__(self, interface="br0"):
        super().__init__()
        
        self.interface = interface
        self._return = None
        
    def run(self):
        packets = sniff(iface=self.interface, filter='ip host 192.168.86.36', timeout = 25)
        self._return = packets
    
    def join(self):
        Thread.join(self)
        return self._return
    


def driver(query_path, q_time, q_name, device_ip, iterations):
    for i in range(iterations):
        sniffer = Sniffer()
        # start capture
        print("Starting Capture...")
        packets = sniffer.start()

        # play query
        subprocess.run(["mpg321", query_path])
        # wait for duration specified and stop and save capture
##        time.sleep(q_time)
        packets = sniffer.join()
        wrpcap(q_name + str(i) + '.pcap', packets)
        
        print("Capture File Saved, iter=" + str(i))
        
        


if __name__ == "__main__":
##    queries = pd.read_csv('/home/scramblesuit/PycharmProjects/speaker-crawler/data/echo_test/echo_test_queries.csv')

##    query_directory = '/home/scramblesuit/PycharmProjects/speaker-crawler/voice_queries/echo_test/'
    query_directory = '/home/pi/Downloads/speaker-crawler-master/voice_queries/echo_test/'
    query_path = '/home/pi/Downloads/speaker-crawler-master/voice_queries/echo_test/_do_dogs_dream?_.mp3'
    from os import listdir
    from os.path import isfile, join
    q_files = [f for f in listdir(query_directory) if isfile(join(query_directory, f))]
##    q_names = queries['Query']
##    q_times = queries['Time']
##    start_capture('192.168.86.36')
##    driver(query_directory + q_files[0], q_times[0], q_names[0], 100)
    driver(query_path, 25, 'do_dogs_dream', '192.168.86.36', 100)





